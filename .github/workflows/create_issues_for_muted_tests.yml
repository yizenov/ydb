name: Create issues for muted tests

on:
  pull_request:
    types:
      - closed
  workflow_dispatch:
    inputs:
      pr_number: 
        description: 'The pull request number'
        required: true
        type: number

env:
  GH_TOKEN: ${{ secrets.YDBOT_TOKEN }}
  BUILD_TYPE: relwithdebinfo

jobs:
  get-pr-base-branch:
    runs-on: ubuntu-latest
    outputs:
      base_branch: ${{ steps.get_base_branch.outputs.base_branch }}
    steps:
      - name: Get PR base branch
        if: github.event_name == 'workflow_dispatch'
        id: get_base_branch
        env:
          GH_TOKEN: ${{ secrets.YDBOT_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.inputs.pr_number }}"
          BASE_BRANCH=$(gh pr view $PR_NUMBER --json baseRefName --jq -r '.baseRefName')
          echo "base_branch=${BASE_BRANCH}" >> $GITHUB_OUTPUT
      - name: Skip for pull_request
        if: github.event_name == 'pull_request'
        run: echo "Skipping - using event data"

  update-ydb:
    if: |
      ((github.event_name == 'pull_request' && 
      github.event.pull_request.merged == true && 
      contains(github.event.pull_request.labels.*.name, 'mute-unmute')) || 
      (github.event_name == 'workflow_dispatch' && needs.get-pr-base-branch.result == 'success'))
    needs: get-pr-base-branch
    uses: ./.github/workflows/reusable/update_ydb_for_muted_tests.yml
    with:
      branch: ${{ github.event.pull_request.base.ref || needs.get-pr-base-branch.outputs.base_branch }}
      build_type: ${{ env.BUILD_TYPE }}
    secrets:
      CI_YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS: ${{ secrets.CI_YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS }}
      GITHUB_TOKEN: ${{ secrets.YDBOT_TOKEN }}

  process-muted-tests:
    needs: [update-ydb, get-pr-base-branch]
    if: |
      ((github.event_name == 'pull_request' && 
      github.event.pull_request.merged == true && 
      contains(github.event.pull_request.labels.*.name, 'mute-unmute')) || 
      (github.event_name == 'workflow_dispatch' && needs.get-pr-base-branch.result == 'success'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ydb[yc] PyGithub requests matplotlib numpy
      
      - name: Setup ydb access
        uses: ./.github/actions/setup_ci_ydb_service_account_key_file_credentials
        with:
          ci_ydb_service_account_key_file_credentials: ${{ secrets.CI_YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS }}
      
      - name: Get PR details for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        id: get_pr_details
        env:
          GH_TOKEN: ${{ secrets.YDBOT_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          PR_NUMBER="${{ github.event.inputs.pr_number }}"
          PR_DATA=$(gh pr view $PR_NUMBER --json baseRefName,mergeCommit --jq '{base_branch: .baseRefName, merge_commit_sha: .mergeCommit.oid}')
          BASE_BRANCH=$(echo "$PR_DATA" | jq -r '.base_branch')
          MERGE_SHA=$(echo "$PR_DATA" | jq -r '.merge_commit_sha // empty')
          echo "base_branch=${BASE_BRANCH}" >> $GITHUB_OUTPUT
          echo "merge_commit_sha=${MERGE_SHA}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
      
      - name: Get muted_ya.txt from merge commit
        id: get_file
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            MERGE_SHA="${{ steps.get_pr_details.outputs.merge_commit_sha }}"
            BASE_BRANCH="${{ steps.get_pr_details.outputs.base_branch }}"
          else
            MERGE_SHA="${{ github.event.pull_request.merge_commit_sha || '' }}"
            BASE_BRANCH="${{ github.event.pull_request.base.ref || 'main' }}"
          fi
          
          python3 .github/scripts/tests/mute_utils/process_muted_tests_after_merge.py get-muted-file \
            --merge_commit_sha="${MERGE_SHA}" \
            --base_branch="${BASE_BRANCH}" \
            --output="muted_ya.txt"
          echo "muted_ya_file=muted_ya.txt" >> $GITHUB_OUTPUT
          echo "base_branch=${BASE_BRANCH}" >> $GITHUB_OUTPUT

      - name: Check config for issues and alerts
        id: check_config
        run: |
          BASE_BRANCH="${{ steps.get_file.outputs.base_branch }}"
          BUILD_TYPE="${{ env.BUILD_TYPE }}"
          
          SHOULD_CREATE_ISSUES=$(python3 .github/scripts/tests/mute_utils/check_config.py "$BASE_BRANCH" "$BUILD_TYPE" issues)
          SHOULD_SEND_ALERTS=$(python3 .github/scripts/tests/mute_utils/check_config.py "$BASE_BRANCH" "$BUILD_TYPE" alerts)
          
          echo "should_create_issues=${SHOULD_CREATE_ISSUES}" >> $GITHUB_OUTPUT
          echo "should_send_alerts=${SHOULD_SEND_ALERTS}" >> $GITHUB_OUTPUT

      - name: Get old muted_ya.txt from base branch
        id: get_old_file
        run: |
          BASE_BRANCH="${{ steps.get_file.outputs.base_branch }}"
          # Get the commit before merge (parent of merge commit)
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            MERGE_SHA="${{ steps.get_pr_details.outputs.merge_commit_sha }}"
            if [ -n "$MERGE_SHA" ]; then
              # Get parent commit (before merge)
              OLD_SHA=$(git rev-parse ${MERGE_SHA}^1 2>/dev/null || echo "")
            else
              # Fallback: get from base branch HEAD~1
              OLD_SHA="origin/${BASE_BRANCH}~1"
            fi
          else
            MERGE_SHA="${{ github.event.pull_request.merge_commit_sha || '' }}"
            if [ -n "$MERGE_SHA" ]; then
              OLD_SHA=$(git rev-parse ${MERGE_SHA}^1 2>/dev/null || echo "")
            else
              OLD_SHA="origin/${BASE_BRANCH}~1"
            fi
          fi
          
          # Try to get old file
          if [ -n "$OLD_SHA" ]; then
            python3 .github/scripts/tests/mute_utils/process_muted_tests_after_merge.py get-muted-file \
              --merge_commit_sha="${OLD_SHA}" \
              --base_branch="${BASE_BRANCH}" \
              --output="old_muted_ya.txt" || touch old_muted_ya.txt
          else
            touch old_muted_ya.txt
          fi
          
          if [ -f old_muted_ya.txt ] && [ -s old_muted_ya.txt ]; then
            echo "old_file=old_muted_ya.txt" >> $GITHUB_OUTPUT
          fi

      - name: DEBUG: Stop before create_issues
        if: steps.check_config.outputs.should_create_issues == 'true'
        run: |
          echo "DEBUG: Stopping before create_issues step"
          echo "muted_ya.txt content preview:"
          head -20 muted_ya.txt || echo "File not found"
          exit 1

      - name: Create issues for muted tests
        if: steps.check_config.outputs.should_create_issues == 'true'
        id: create_issues
        env:
          GITHUB_TOKEN: ${{ secrets.YDBOT_TOKEN }}
        run: |
          OLD_FILE="${{ steps.get_old_file.outputs.old_file || '' }}"
          if [ -n "$OLD_FILE" ] && [ -f "$OLD_FILE" ]; then
            python3 .github/scripts/tests/mute_utils/create_new_muted_ya.py create_issues \
              --file_path=muted_ya.txt \
              --old_muted_ya_path="$OLD_FILE" \
              --branch=${{ steps.get_file.outputs.base_branch }} \
              --build_type=${{ env.BUILD_TYPE }}
          else
            python3 .github/scripts/tests/mute_utils/create_new_muted_ya.py create_issues \
              --file_path=muted_ya.txt \
              --branch=${{ steps.get_file.outputs.base_branch }} \
              --build_type=${{ env.BUILD_TYPE }}
          fi
          # Script creates created_issues.txt and saves path in GITHUB_OUTPUT
          if [ -f created_issues.txt ]; then
            echo "issues_file=created_issues.txt" >> $GITHUB_OUTPUT
          fi
      
      - name: Prepare team notifications for stable branches
        if: steps.check_config.outputs.should_send_alerts == 'true' && steps.check_config.outputs.should_create_issues != 'true'
        id: prepare_notifications
        run: |
          OLD_FILE="${{ steps.get_old_file.outputs.old_file || '' }}"
          if [ -n "$OLD_FILE" ] && [ -f "$OLD_FILE" ]; then
            python3 .github/scripts/tests/mute_utils/create_new_muted_ya.py prepare_team_notifications \
              --new_muted_ya_path=muted_ya.txt \
              --old_muted_ya_path="$OLD_FILE" \
              --branch=${{ steps.get_file.outputs.base_branch }} \
              --build_type=${{ env.BUILD_TYPE }}
          else
            python3 .github/scripts/tests/mute_utils/create_new_muted_ya.py prepare_team_notifications \
              --new_muted_ya_path=muted_ya.txt \
              --branch=${{ steps.get_file.outputs.base_branch }} \
              --build_type=${{ env.BUILD_TYPE }}
          fi
          if [ -f created_issues.txt ]; then
            echo "issues_file=created_issues.txt" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Telegram notifications or queue for aggregation
        if: steps.check_config.outputs.should_send_alerts == 'true' && (steps.create_issues.outputs.issues_file != '' || steps.prepare_notifications.outputs.issues_file != '')
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_YDBOT_TOKEN }}
          TEAM_CHANNELS: ${{ vars.TG_TEAM_CHANNELS }}
          BASE_BRANCH: ${{ steps.get_file.outputs.base_branch }}
          BUILD_TYPE: ${{ env.BUILD_TYPE }}
          CI_YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS: ${{ secrets.CI_YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS }}
        run: |
          ISSUES_FILE="${{ steps.create_issues.outputs.issues_file || steps.prepare_notifications.outputs.issues_file }}"
          python3 .github/scripts/telegram/parse_and_send_team_issues.py \
            --on-mute-change-update \
            --file "$ISSUES_FILE" \
            --bot-token "$TELEGRAM_BOT_TOKEN" \
            --team-channels "$TEAM_CHANNELS" \
            --include-plots \
            --delay 2 \
            --branch "$BASE_BRANCH" \
            --build-type "$BUILD_TYPE"
      
      - name: Comment PR
        env:
          GITHUB_TOKEN: ${{ secrets.YDBOT_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER="${{ steps.get_pr_details.outputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          python3 .github/scripts/tests/mute_utils/process_muted_tests_after_merge.py comment-pr \
            --pr_number="${PR_NUMBER}" \
            --base_branch="${{ steps.get_file.outputs.base_branch }}" \
            --issues_file="${{ steps.create_issues.outputs.issues_file || '' }}"
